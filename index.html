<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pepito's House - Men√∫ Digital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --rojo: #e63946;
            --amarillo: #ffb703;
            --oscuro: #1d3557;
            --blanco: #f1faee;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--blanco);
            margin: 0;
            padding: 0;
            color: var(--oscuro);
        }

        header {
            background-color: var(--rojo);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .logo-img {
            width: 80px;
            border-radius: 50%;
            border: 3px solid var(--amarillo);
        }

        .acerca-de {
            position: absolute;
            top: 10px;
            right: 15px;
            color: var(--amarillo);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .container {
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .product-info h3 { margin: 0; color: var(--rojo); }
        .product-info p { margin: 5px 0; font-size: 0.9rem; }
        .price { font-weight: bold; color: #28a745; }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
        }

        .btn-add { background-color: var(--amarillo); color: var(--oscuro); font-weight: bold; }
        .btn-remove { background-color: #ddd; }

        #cart-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--oscuro);
            color: white;
            padding: 15px;
            text-align: center;
            display: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            color: var(--oscuro);
        }

        .bcv-box {
            background: #f8f9fa;
            border-left: 5px solid var(--rojo);
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

<header>
    <a href="#footer" class="acerca-de" onclick="mostrarAcerca()">Acerca de esta web</a>
    <img src="logo.jpg" alt="Pepito's House Logo" class="logo-img">
    <h1>Pepito's House</h1>
    <p>¬°El mejor sabor de la 251!</p>
</header>

<div class="container" id="menu-container">
    <p style="text-align:center;">Cargando men√∫ delicioso...</p>
</div>

<div id="cart-bar">
    <span id="cart-total">Total: $0.00</span>
    <button onclick="abrirConfirmacion()" style="margin-left:20px; background:var(--amarillo); color:var(--oscuro); font-weight:bold;">Ver Pedido</button>
</div>

<div id="modalConfirmacion" class="modal">
    <div class="modal-content">
        <h2>Confirmar Pedido</h2>
        <div id="lista-pedido"></div>
        <div class="bcv-box" id="bcv-info">
            Cargando tasa BCV...
        </div>
        <hr>
        <p>¬øCu√°nto es el costo del delivery hasta su ubicaci√≥n?</p>
        <input type="number" id="delivery-cost" placeholder="Ej: 2" style="width:100%; padding:10px; margin-bottom:10px;">
        <p id="total-final" style="font-weight:bold; font-size:1.2rem;"></p>
        <button onclick="enviarWhatsApp()" style="width:100%; background:#25d366; color:white; padding:15px; font-size:1.1rem; font-weight:bold;">
            <i class="fab fa-whatsapp"></i> ENVIAR A WHATSAPP
        </button>
        <button onclick="cerrarModal()" style="width:100%; background:#ccc; margin-top:10px;">Cerrar</button>
    </div>
</div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsTRhoswf3zopWO5PEusQsYdYglnUlWTX9HzFIvewpy4vED9fQbs9Z0V3EdQ-AGMGLlpmcs_LL_cP3/pub?gid=0&single=true&output=tsv';
    const WHATSAPP_NUMBER = '584122525407';
    let productos = [];
    let carrito = {};
    let tasaBCV = 341.31; // Tasa por defecto si falla el fetch
    let ubicacionActual = "No proporcionada";

    // 1. Obtener Tasa BCV (Simulado o v√≠a Proxy)
    async function obtenerTasa() {
        try {
            // Nota: En un entorno real se usar√≠a un servidor intermedio para evitar CORS con la web del BCV
            document.getElementById('bcv-info').innerHTML = `Tasa BCV: <b>${tasaBCV} Bs/$</b>`;
        } catch (e) { console.log("Error tasa", e); }
    }

    // 2. Cargar datos de Google Sheets
    async function cargarMenu() {
        const response = await fetch(SHEET_URL);
        const data = await response.text();
        const filas = data.split('\n').slice(1); // Saltar cabecera

        const container = document.getElementById('menu-container');
        container.innerHTML = '';

        filas.forEach(fila => {
            const [id, name, price, currency, description, category] = fila.split('\t');
            if(id) {
                productos.push({id, name, price: parseFloat(price), description});
                container.innerHTML += `
                    <div class="product-card">
                        <div class="product-info">
                            <h3>${name}</h3>
                            <p>${description}</p>
                            <span class="price">$${price}</span>
                        </div>
                        <div class="controls">
                            <button class="btn-remove" onclick="cambiarCantidad('${id}', -1)">-</button>
                            <span id="qty-${id}">0</span>
                            <button class="btn-add" onclick="cambiarCantidad('${id}', 1)">+</button>
                        </div>
                    </div>
                `;
            }
        });
    }

    function cambiarCantidad(id, delta) {
        carrito[id] = (carrito[id] || 0) + delta;
        if (carrito[id] <= 0) delete carrito[id];
        document.getElementById(`qty-${id}`).innerText = carrito[id] || 0;
        actualizarBarra();
    }

    function actualizarBarra() {
        let total = 0;
        Object.keys(carrito).forEach(id => {
            const p = productos.find(prod => prod.id === id);
            total += p.price * carrito[id];
        });
        document.getElementById('cart-bar').style.display = total > 0 ? 'block' : 'none';
        document.getElementById('cart-total').innerText = `Total: $${total.toFixed(2)}`;
    }

    function abrirConfirmacion() {
        obtenerTasa();
        obtenerUbicacion();
        const modal = document.getElementById('modalConfirmacion');
        const lista = document.getElementById('lista-pedido');
        let html = '<ul>';
        let totalDolar = 0;

        Object.keys(carrito).forEach(id => {
            const p = productos.find(prod => prod.id === id);
            const subtotal = p.price * carrito[id];
            totalDolar += subtotal;
            html += `<li>${carrito[id]}x ${p.name} - $${subtotal.toFixed(2)}</li>`;
        });

        const totalBs = totalDolar * tasaBCV;
        document.getElementById('total-final').innerHTML = `Total Productos: $${totalDolar.toFixed(2)} / Bs. ${totalBs.toLocaleString('es-VE')}`;
        lista.innerHTML = html + '</ul>';
        modal.style.display = 'block';
    }

    function obtenerUbicacion() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                ubicacionActual = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
            });
        }
    }

    function enviarWhatsApp() {
        let texto = "¬°Hola! Quisiera realizar el siguiente pedido:\n\n";
        let totalDolar = 0;
        Object.keys(carrito).forEach(id => {
            const p = productos.find(prod => prod.id === id);
            texto += `- ${carrito[id]}x ${p.name} ($${p.price})\n`;
            totalDolar += p.price * carrito[id];
        });

        const delivery = parseFloat(document.getElementById('delivery-cost').value) || 0;
        const totalFinalDolar = totalDolar + delivery;
        const totalFinalBs = totalFinalDolar * tasaBCV;

        texto += `\nSubtotal: $${totalDolar.toFixed(2)}`;
        texto += `\nDelivery: $${delivery.toFixed(2)}`;
        texto += `\n*TOTAL A PAGAR: $${totalFinalDolar.toFixed(2)}*`;
        texto += `\n*TOTAL EN BS (Tasa ${tasaBCV}): Bs. ${totalFinalBs.toLocaleString('es-VE')}*`;
        texto += `\n\nüìç Ubicaci√≥n de entrega: ${ubicacionActual}`;

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(texto)}`;
        window.open(url, '_blank');
    }

    function mostrarAcerca() {
        alert("Desarrollado por: Antonio Itriago\nAnalista, Dise√±ador y Desarrollador de Sistemas.\nContacto: wa.me/584122525407");
    }

    function cerrarModal() { document.getElementById('modalConfirmacion').style.display = 'none'; }

    window.onload = cargarMenu;
</script>

</body>
</html>
