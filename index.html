<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pepito's House 251 - Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* Colores extraídos visualmente del perfil (Rojo y Amarillo Pepito) */
            --primary: #e63946; 
            --secondary: #ffb703;
            --dark: #1d3557;
            --light: #f1faee;
        }
        .bg-primary { background-color: var(--primary); }
        .text-primary { color: var(--primary); }
        .btn-cart { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="logo.jpg" alt="Logo" class="h-12 w-12 rounded-full object-cover">
                <span class="font-bold text-xl tracking-tight">Pepito's House 251</span>
            </div>
            <a href="#acerca" onclick="toggleModal('modal-info')" class="text-sm font-semibold text-blue-600 hover:underline">Acerca de esta web</a>
        </div>
    </header>

    <section class="bg-primary text-white py-6">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-2xl font-bold">¡Los mejores Pepitos de Barquisimeto!</h1>
            <p class="text-sm opacity-90">Ventas directas por WhatsApp</p>
        </div>
    </section>

    <main class="container mx-auto px-4 py-8">
        <div id="catalog" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <p class="text-center col-span-full">Cargando menú delicioso...</p>
        </div>
    </main>

    <button onclick="toggleModal('modal-cart')" class="btn-cart bg-green-500 text-white p-4 rounded-full shadow-lg hover:bg-green-600 transition">
        <i class="fas fa-shopping-cart text-2xl"></i>
        <span id="cart-count" class="absolute top-0 right-0 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
    </button>

    <div id="modal-info" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6 relative">
            <button onclick="toggleModal('modal-info')" class="absolute top-3 right-3 text-gray-500 text-xl">&times;</button>
            <h2 class="text-xl font-bold mb-4">Información del Sistema</h2>
            <p class="text-gray-700 mb-2"><strong>Analista, Diseñador y Desarrollador:</strong></p>
            <p class="text-lg">Antonio Itriago</p>
            <p class="text-sm text-gray-500 mb-4">Sistemas de Información Computarizados</p>
            <hr class="mb-4">
            <a href="https://wa.me/584122525407" class="text-green-600 font-bold flex items-center">
                Contactar al Desarrollador: wa.me/584122525407
            </a>
        </div>
    </div>

    <div id="modal-cart" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">Confirmar Pedido</h2>
            <div id="cart-items" class="space-y-3 mb-6">
                </div>
            
            <div class="border-t pt-4">
                <p class="flex justify-between text-lg"><span>Total USD:</span> <span id="total-usd" class="font-bold">0.00</span></p>
                <p class="flex justify-between text-sm text-gray-600 italic"><span>Tasa BCV:</span> <span id="tasa-val">Cargando...</span></p>
                <p class="flex justify-between text-xl text-primary font-bold"><span>Total Bs:</span> <span id="total-bs">0.00</span></p>
            </div>

            <div class="mt-6 space-y-3">
                <p class="text-xs text-gray-500">Se incluirá tu ubicación para calcular el delivery.</p>
                <button onclick="sendOrder()" class="w-full bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 flex items-center justify-center">
                    <i class="fab fa-whatsapp mr-2"></i> Enviar a WhatsApp
                </button>
                <button onclick="toggleModal('modal-cart')" class="w-full text-gray-500 py-2">Seguir Comprando</button>
            </div>
        </div>
    </div>

    <script>
        let cart = [];
        let bcvRate = 0;
        let userLocation = "No proporcionada";
        const TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRsTRhoswf3zopWO5PEusQsYdYglnUlWTX9HzFIvewpy4vED9fQbs9Z0V3EdQ-AGMGLlpmcs_LL_cP3/pub?gid=0&single=true&output=tsv';
        const WHATSAPP_NUM = "584122525407";

        // 1. Obtener Tasa BCV
        async function fetchBCV() {
            try {
                // Usando una API de referencia para la tasa BCV (ejemplo)
                const response = await fetch('https://ve.dolarapi.com/v1/dolares/oficial');
                const data = await response.json();
                bcvRate = data.promedio || data.oficial || 60.50; // Fallback en caso de error
                document.getElementById('tasa-val').innerText = bcvRate.toFixed(2) + " Bs.";
            } catch (e) {
                console.error("Error tasa:", e);
                bcvRate = 60.50; // Valor manual de respaldo
            }
        }

        // 2. Cargar Productos desde Google Sheets
        async function loadProducts() {
            try {
                const res = await fetch(TSV_URL);
                const text = await res.text();
                const rows = text.split('\n').slice(1); // Saltar cabecera
                const catalog = document.getElementById('catalog');
                catalog.innerHTML = '';

                rows.forEach(row => {
                    const [id, name, price, currency, description, category] = row.split('\t');
                    if(id) {
                        catalog.innerHTML += `
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                <span class="text-xs font-bold text-primary uppercase">${category}</span>
                                <h3 class="text-lg font-bold">${name}</h3>
                                <p class="text-gray-600 text-sm mb-3">${description}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-xl font-bold font-mono">$${parseFloat(price).toFixed(2)}</span>
                                    <button onclick="addToCart('${id}', '${name}', ${price})" class="bg-primary text-white px-4 py-1 rounded-full text-sm hover:opacity-80">
                                        + Agregar
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
            } catch (e) {
                catalog.innerHTML = '<p class="text-red-500">Error cargando el menú.</p>';
            }
        }

        // 3. Gestión del Carrito
        function addToCart(id, name, price) {
            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({ id, name, price, qty: 1 });
            }
            updateCartUI();
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.reduce((acc, item) => acc + item.qty, 0);
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            
            let totalUSD = 0;
            cart.forEach(item => {
                const subtotal = item.price * item.qty;
                totalUSD += subtotal;
                container.innerHTML += `
                    <div class="flex justify-between items-center border-b pb-2">
                        <div>
                            <p class="font-bold">${item.name}</p>
                            <p class="text-sm text-gray-500">$${item.price} x ${item.qty}</p>
                        </div>
                        <span class="font-bold">$${subtotal.toFixed(2)}</span>
                    </div>
                `;
            });

            document.getElementById('total-usd').innerText = totalUSD.toFixed(2);
            document.getElementById('total-bs').innerText = (totalUSD * bcvRate).toLocaleString('es-VE', {minimumFractionDigits: 2});
        }

        // 4. Ubicación y Envío
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLocation = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                });
            }
        }

        function sendOrder() {
            if (cart.length === 0) return alert("El carrito está vacío");

            let totalUSD = document.getElementById('total-usd').innerText;
            let totalBS = document.getElementById('total-bs').innerText;

            let message = `*NUEVO PEDIDO - PEPITO'S HOUSE 251*%0A%0A`;
            cart.forEach(item => {
                message += `• ${item.qty}x ${item.name} ($${item.price})%0A`;
            });
            
            message += `%0A--------------------------%0A`;
            message += `*TOTAL USD:* $${totalUSD}%0A`;
            message += `*TASA BCV:* ${bcvRate} Bs.%0A`;
            message += `*TOTAL BS:* ${totalBS} Bs.%0A%0A`;
            message += `*Ubicación para delivery:* ${userLocation}%0A`;
            message += `¿Cuál es el costo del delivery hasta aquí?`;

            window.open(`https://wa.me/${WHATSAPP_NUM}?text=${message}`, '_blank');
        }

        function toggleModal(id) {
            const modal = document.getElementById(id);
            modal.classList.toggle('hidden');
        }

        // Inicialización
        fetchBCV();
        loadProducts();
        getLocation();
    </script>
</body>
</html>
